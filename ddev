#!/bin/bash

# Script Docker portable pour Laravel
CONTAINER="ecommerce-app-1"

case $1 in
    artisan)
        shift
        docker exec -it $CONTAINER php artisan "$@"
        ;;
    composer)
        shift
        docker exec -it $CONTAINER composer "$@"
        ;;
    php)
        shift
        docker exec -it $CONTAINER php "$@"
        ;;
    npm)
        shift
        docker exec -it $CONTAINER npm "$@"
        ;;
    shell|sh|bash)
        docker exec -it $CONTAINER sh
        ;;
    tinker)
        docker exec -it $CONTAINER php artisan tinker
        ;;
    migrate)
        docker exec -it $CONTAINER php artisan migrate
        ;;
    fresh)
        docker exec -it $CONTAINER php artisan migrate:fresh --seed
        ;;
    rebuild)
        if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker n'est pas dÃ©marrÃ© !"
            echo "ğŸ’¡ DÃ©marrez Docker Desktop et rÃ©essayez"
            exit 1
        fi
        echo "ğŸ”¥ Rebuild complet de l'environnement..."
        echo "ğŸ›‘ ArrÃªt des containers..."
        docker-compose down
        echo "ğŸ—ï¸  Rebuild des images..."
        docker-compose build --no-cache
        echo "ğŸš€ DÃ©marrage des containers..."
        docker-compose up -d
        echo "â³ Attente que PostgreSQL soit prÃªt..."
        sleep 5
        echo "ğŸ—„ï¸  ExÃ©cution des migrations..."
        docker exec -it $CONTAINER php artisan migrate
        echo ""
        echo "âœ… Rebuild terminÃ© avec succÃ¨s !"
        echo "ğŸ“± Laravel: http://localhost:8001"
        echo "ğŸ—ƒï¸  pgAdmin: http://localhost:5050"
        echo ""
        echo "ğŸ’¡ N'oubliez pas de lancer 'npm run dev' dans un autre terminal !"
        ;;
    start)
        if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker n'est pas dÃ©marrÃ© !"
            echo "ğŸ’¡ DÃ©marrez Docker Desktop et rÃ©essayez"
            exit 1
        fi
        echo "ğŸš€ DÃ©marrage de l'environnement de dÃ©veloppement..."
        docker-compose build --no-cache
        docker-compose up -d
        echo "âœ… Docker containers dÃ©marrÃ©s!"
        echo "ğŸ“¦ Installation des dÃ©pendances..."
        docker exec -it $CONTAINER composer install
        echo "ğŸ”‘ GÃ©nÃ©ration de la clÃ© d'application..."
        docker exec -it $CONTAINER php artisan key:generate
        echo "ğŸ—„ï¸  ExÃ©cution des migrations..."
        docker exec -it $CONTAINER php artisan migrate
        echo ""
        echo "ğŸ‰ Environnement prÃªt !"
        echo "ğŸ“± Laravel: http://localhost:8001"
        echo "ğŸ—ƒï¸  pgAdmin: http://localhost:5050"
        echo ""
        echo "ğŸ’¡ N'oubliez pas de lancer 'npm run dev' dans un autre terminal !"
        ;;
    stop)
        if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker n'est pas dÃ©marrÃ© !"
            echo "ğŸ’¡ DÃ©marrez Docker Desktop et rÃ©essayez"
            exit 1
        fi
        echo "ğŸ›‘ ArrÃªt de l'environnement de dÃ©veloppement..."
        docker-compose stop
        echo "âœ… Containers arrÃªtÃ©s (donnÃ©es prÃ©servÃ©es)"
        ;;
    restart)
        if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker n'est pas dÃ©marrÃ© !"
            echo "ğŸ’¡ DÃ©marrez Docker Desktop et rÃ©essayez"
            exit 1
        fi
        echo "ğŸ”„ RedÃ©marrage de l'environnement..."
        docker-compose restart
        echo "âœ… RedÃ©marrage terminÃ©!"
        ;;
    status)
        if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker n'est pas dÃ©marrÃ© !"
            echo "ğŸ’¡ DÃ©marrez Docker Desktop et rÃ©essayez"
            exit 1
        fi
        echo "ğŸ“Š Statut des containers:"
        docker-compose ps
        ;;
    up)
        if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker n'est pas dÃ©marrÃ© !"
            echo "ğŸ’¡ DÃ©marrez Docker Desktop et rÃ©essayez"
            exit 1
        fi
        docker-compose up -d
        ;;
    down)
        if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker n'est pas dÃ©marrÃ© !"
            echo "ğŸ’¡ DÃ©marrez Docker Desktop et rÃ©essayez"
            exit 1
        fi
        docker-compose down
        ;;
    build)
        if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker n'est pas dÃ©marrÃ© !"
            echo "ğŸ’¡ DÃ©marrez Docker Desktop et rÃ©essayez"
            exit 1
        fi
        docker-compose build --no-cache
        ;;
    logs)
        if ! docker info > /dev/null 2>&1; then
            echo "âŒ Docker n'est pas dÃ©marrÃ© !"
            echo "ğŸ’¡ DÃ©marrez Docker Desktop et rÃ©essayez"
            exit 1
        fi
        docker-compose logs -f
        ;;
    help)
        echo "ğŸ”§ Commandes disponibles:"
        echo "  ./ddev start     - Build et dÃ©marrer l'environnement complet"
        echo "  ./ddev stop      - ArrÃªter l'environnement (prÃ©serve les donnÃ©es)"
        echo "  ./ddev restart   - RedÃ©marrer les containers"
        echo "  ./ddev status    - Voir le statut des containers"
        echo ""
        echo "ğŸ“ Commandes Laravel:"
        echo "  ./ddev artisan [cmd]  - ExÃ©cuter une commande artisan"
        echo "  ./ddev composer [cmd] - ExÃ©cuter composer"
        echo "  ./ddev migrate        - Lancer les migrations"
        echo "  ./ddev fresh          - Migrations fresh + seed"
        echo "  ./ddev tinker         - Laravel Tinker"
        echo ""
        echo "ğŸ³ Commandes Docker:"
        echo "  ./ddev shell     - AccÃ©der au container"
        echo "  ./ddev logs      - Voir les logs"
        echo "  ./ddev build     - Rebuild les containers"
        ;;
    *)
        docker exec -it $CONTAINER "$@"
        ;;
esac