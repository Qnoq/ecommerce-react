#!/usr/bin/env bash

# Script Docker portable pour Laravel - Version Universelle macOS/Windows
CONTAINER="ecommerce-app-1"

# DÃ©tection de l'OS
detect_os() {
    case "$(uname -s)" in
        Darwin*)    OS="mac";;
        MINGW*)     OS="windows";;
        CYGWIN*)    OS="windows";;
        MSYS*)      OS="windows";;
        *)          OS="linux";;
    esac
}

# Fonction pour dÃ©terminer la commande docker-compose
get_compose_cmd() {
    if command -v docker-compose &> /dev/null; then
        echo "docker-compose"
    elif docker compose version &> /dev/null; then
        echo "docker compose"
    else
        echo ""
    fi
}

# Fonction pour vÃ©rifier Docker selon l'OS
check_docker() {
    detect_os
    
    if ! command -v docker &> /dev/null; then
        echo "âŒ Docker n'est pas installÃ© !"
        if [ "$OS" = "mac" ]; then
            echo "ğŸ’¡ Installez Docker Desktop sur macOS:"
            echo "   brew install --cask docker"
            echo "   ou tÃ©lÃ©chargez depuis https://www.docker.com/products/docker-desktop"
        elif [ "$OS" = "windows" ]; then
            echo "ğŸ’¡ Installez Docker Desktop sur Windows:"
            echo "   TÃ©lÃ©chargez depuis https://www.docker.com/products/docker-desktop"
        fi
        exit 1
    fi
    
    if ! docker info > /dev/null 2>&1; then
        echo "âŒ Docker n'est pas dÃ©marrÃ© !"
        if [ "$OS" = "mac" ]; then
            echo "ğŸ’¡ DÃ©marrez Docker Desktop sur macOS:"
            echo "   Applications > Docker > Docker Desktop"
            echo "   ou dans Spotlight: Docker Desktop"
        elif [ "$OS" = "windows" ]; then
            echo "ğŸ’¡ DÃ©marrez Docker Desktop sur Windows:"
            echo "   Cherchez 'Docker Desktop' dans le menu DÃ©marrer"
        fi
        exit 1
    fi
    
    # VÃ©rifier docker-compose
    COMPOSE_CMD=$(get_compose_cmd)
    if [ -z "$COMPOSE_CMD" ]; then
        echo "âŒ Docker Compose n'est pas disponible !"
        if [ "$OS" = "mac" ]; then
            echo "ğŸ’¡ Installez docker-compose:"
            echo "   brew install docker-compose"
        fi
        exit 1
    fi
}

# Fonction pour attendre que le container soit prÃªt
wait_for_container() {
    echo "â³ Attente du dÃ©marrage du container..."
    local max_attempts=30
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        if docker exec $CONTAINER php --version > /dev/null 2>&1; then
            echo "âœ… Container prÃªt!"
            return 0
        fi
        echo "   Tentative $attempt/$max_attempts..."
        sleep 2
        ((attempt++))
    done
    
    echo "âŒ Le container n'a pas dÃ©marrÃ© correctement"
    echo "ğŸ’¡ VÃ©rifiez les logs avec: docker-compose logs"
    exit 1
}

# Fonction pour afficher l'OS dÃ©tectÃ©
show_os_info() {
    detect_os
    case $OS in
        mac)     echo "ğŸ macOS dÃ©tectÃ©";;
        windows) echo "ğŸªŸ Windows dÃ©tectÃ©";;
        linux)   echo "ğŸ§ Linux dÃ©tectÃ©";;
    esac
}

case $1 in
    artisan)
        check_docker
        shift
        docker exec -it $CONTAINER php artisan "$@"
        ;;
    composer)
        check_docker
        shift
        docker exec -it $CONTAINER composer "$@"
        ;;
    php)
        check_docker
        shift
        docker exec -it $CONTAINER php "$@"
        ;;
    npm)
        check_docker
        shift
        docker exec -it $CONTAINER npm "$@"
        ;;
    shell|sh|bash)
        check_docker
        docker exec -it $CONTAINER sh
        ;;
    tinker)
        check_docker
        docker exec -it $CONTAINER php artisan tinker
        ;;
    migrate)
        check_docker
        docker exec -it $CONTAINER php artisan migrate
        ;;
    fresh)
        check_docker
        docker exec -it $CONTAINER php artisan migrate:fresh --seed
        ;;
    rebuild)
        check_docker
        COMPOSE_CMD=$(get_compose_cmd)
        show_os_info
        echo "ğŸ”¥ Rebuild complet de l'environnement..."
        echo "ğŸ›‘ ArrÃªt des containers..."
        $COMPOSE_CMD down
        echo "ğŸ—ï¸  Rebuild des images..."
        $COMPOSE_CMD build --no-cache
        echo "ğŸš€ DÃ©marrage des containers..."
        $COMPOSE_CMD up -d
        
        wait_for_container
        
        echo "ğŸ—„ï¸  ExÃ©cution des migrations..."
        docker exec -it $CONTAINER php artisan migrate
        echo ""
        echo "âœ… Rebuild terminÃ© avec succÃ¨s !"
        echo "ğŸ“± Laravel: http://localhost:8001"
        echo "ğŸ—ƒï¸  pgAdmin: http://localhost:5050"
        echo ""
        echo "ğŸ’¡ N'oubliez pas de lancer 'npm run dev' dans un autre terminal !"
        ;;
    start)
        check_docker
        COMPOSE_CMD=$(get_compose_cmd)
        show_os_info
        echo "ğŸš€ DÃ©marrage de l'environnement de dÃ©veloppement..."
        $COMPOSE_CMD build --no-cache
        $COMPOSE_CMD up -d
        
        wait_for_container
        
        echo "ğŸ“¦ Installation des dÃ©pendances..."
        docker exec -it $CONTAINER composer install
        echo "ğŸ”‘ GÃ©nÃ©ration de la clÃ© d'application..."
        docker exec -it $CONTAINER php artisan key:generate
        echo "ğŸ—„ï¸  ExÃ©cution des migrations..."
        docker exec -it $CONTAINER php artisan migrate
        echo ""
        echo "ğŸ‰ Environnement prÃªt !"
        echo "ğŸ“± Laravel: http://localhost:8001"
        echo "ğŸ—ƒï¸  pgAdmin: http://localhost:5050"
        echo ""
        echo "ğŸ’¡ N'oubliez pas de lancer 'npm run dev' dans un autre terminal !"
        ;;
    stop)
        check_docker
        echo "ğŸ›‘ ArrÃªt de l'environnement de dÃ©veloppement..."
        docker-compose stop
        echo "âœ… Containers arrÃªtÃ©s (donnÃ©es prÃ©servÃ©es)"
        ;;
    restart)
        check_docker
        echo "ğŸ”„ RedÃ©marrage de l'environnement..."
        docker-compose restart
        echo "âœ… RedÃ©marrage terminÃ©!"
        ;;
    status)
        check_docker
        show_os_info
        echo "ğŸ“Š Statut des containers:"
        docker-compose ps
        echo ""
        echo "ğŸ” Ressources systÃ¨me:"
        docker stats --no-stream
        ;;
    up)
        check_docker
        docker-compose up -d
        ;;
    down)
        check_docker
        docker-compose down
        ;;
    build)
        check_docker
        docker-compose build --no-cache
        ;;
    logs)
        check_docker
        docker-compose logs -f
        ;;
    clean)
        check_docker
        echo "ğŸ§¹ Nettoyage de l'environnement Docker..."
        docker-compose down -v
        docker system prune -f
        docker volume prune -f
        echo "âœ… Nettoyage terminÃ©!"
        ;;
    info)
        show_os_info
        echo "ğŸ“‹ Informations systÃ¨me:"
        echo "   Docker: $(docker --version 2>/dev/null || echo 'Non installÃ©')"
        echo "   Docker Compose: $(docker-compose --version 2>/dev/null || echo 'Non installÃ©')"
        echo "   Container: $CONTAINER"
        ;;
    help)
        show_os_info
        echo ""
        echo "ğŸ”§ Commandes disponibles:"
        echo "  ddev start     - Build et dÃ©marrer l'environnement complet"
        echo "  ddev stop      - ArrÃªter l'environnement (prÃ©serve les donnÃ©es)"
        echo "  ddev restart   - RedÃ©marrer les containers"
        echo "  ddev rebuild   - Rebuild complet de l'environnement"
        echo "  ddev status    - Voir le statut des containers"
        echo "  ddev clean     - Nettoyer complÃ¨tement Docker"
        echo "  ddev info      - Informations systÃ¨me et Docker"
        echo ""
        echo "ğŸ“ Commandes Laravel:"
        echo "  ddev artisan [cmd]  - ExÃ©cuter une commande artisan"
        echo "  ddev composer [cmd] - ExÃ©cuter composer"
        echo "  ddev migrate        - Lancer les migrations"
        echo "  ddev fresh          - Migrations fresh + seed"
        echo "  ddev tinker         - Laravel Tinker"
        echo ""
        echo "ğŸ³ Commandes Docker:"
        echo "  ddev shell     - AccÃ©der au container"
        echo "  ddev logs      - Voir les logs"
        echo "  ddev build     - Rebuild les containers"
        echo "  ddev up        - DÃ©marrer les containers"
        echo "  ddev down      - ArrÃªter et supprimer les containers"
        echo ""
        echo "ğŸ’¡ Exemples d'usage:"
        echo "  ddev artisan make:model Product"
        echo "  ddev composer require laravel/breeze"
        echo "  ddev npm install"
        echo "  ddev npm run dev"
        ;;
    *)
        check_docker
        docker exec -it $CONTAINER "$@"
        ;;
esac